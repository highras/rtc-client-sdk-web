const RTC_SDK_VERSION="1.0.0",RTC_ERROR_CODE={RTC_EC_ALREADY_LOGIN:300001,RTC_EC_ENTER_ROOM_ERROR:300002},RTC_EVENT={RTC_EV_ENTER:1,RTC_EV_LEAVE:2,RTC_EV_CAMERA_CLOSE:3,RTC_EV_CAMERA_OPEN:4,RTC_EV_MICROPHONE_CLOSE:5,RTC_EV_MICROPHONE_OPEN:6};function RtcPublisher(e){var t={};return t.constraints=void 0===e?{audio:!0,video:!0}:e,t.publish=async function(e,n,r){var i=t.__internal.prepareUrl(n);t.pc.addTransceiver("audio",{direction:"sendonly"}),t.pc.addTransceiver("video",{direction:"sendonly"}),(await navigator.mediaDevices.getUserMedia(t.constraints)).getTracks().forEach(function(e){t.pc.addTrack(e),t.ontrack&&t.ontrack({track:e})});var o=await t.pc.createOffer();await t.pc.setLocalDescription(o);var a={api:i.apiUrl,tid:i.tid,streamurl:i.streamUrl,clientip:"",sdp:o.sdp};let l=new fpnn.FPClient({endpoint:"wss://"+e+"/service/websocket",autoReconnect:!1,connectionTimeout:1e4});l.connect(),l.on("connect",function(){let e={flag:1,method:"OnUserPublish",payload:msgpack.encode(a)};l.sendQuest(e,function(e){session=rtm.RTMConfig.MsgPack.decode(e.payload,{codec:rtm.RTMConfig.MsgPack.createCodec({int64:!0})}),t.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:session.sdp})),session.simulator=i.schema+"//"+i.urlObject.server+":"+i.port+"/rtc/v1/nack/",r(session)},1e4)})},t.close=function(){t.pc&&t.pc.close(),t.pc=null},t.ontrack=function(e){t.stream.addTrack(e.track)},t.__internal={defaultPath:"/rtc/v1/publish/",prepareUrl:function(e){var n=t.__internal.parse(e),r=n.user_query.schema;r=r?r+":":window.location.protocol;var i=n.port||1985;"https:"===r&&(i=n.port||443);var o=n.user_query.play||t.__internal.defaultPath;for(var a in o.lastIndexOf("/")!==o.length-1&&(o+="/"),l=r+"//"+n.server+":"+i+o,n.user_query)"api"!==a&&"play"!==a&&(l+="&"+a+"="+n.user_query[a]);var l=l.replace(o+"&",o+"?");return{apiUrl:l,streamUrl:n.url,schema:r,urlObject:n,port:i,tid:Number(parseInt((new Date).getTime()*Math.random()*100)).toString(16).slice(0,7)}},parse:function(e){var n=document.createElement("a");n.href=e.replace("rtmp://","http://").replace("webrtc://","http://").replace("rtc://","http://");var r=n.hostname,i=n.pathname.substring(1,n.pathname.lastIndexOf("/")),o=n.pathname.slice(n.pathname.lastIndexOf("/")+1);if((i=i.replace("...vhost...","?vhost=")).indexOf("?")>=0){var a=i.slice(i.indexOf("?"));i=i.slice(0,i.indexOf("?")),a.indexOf("vhost=")>0&&(r=a.slice(a.indexOf("vhost=")+"vhost=".length)).indexOf("&")>0&&(r=r.slice(0,r.indexOf("&")))}if(n.hostname===r){/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/.test(n.hostname)&&(r="__defaultVhost__")}var l="rtmp";e.indexOf("://")>0&&(l=e.slice(0,e.indexOf("://")));var s=n.port;s||("http"===l?s=80:"https"===l?s=443:"rtmp"===l&&(s=1935));var c={url:e,schema:l,server:n.hostname,port:s,vhost:r,app:i,stream:o};return t.__internal.fill_query(n.search,c),c.port||"webrtc"!==l&&"rtc"!==l||("https"===c.user_query.schema?c.port=443:0===window.location.href.indexOf("https://")?c.port=443:c.port=1985),c},fill_query:function(e,t){if(t.user_query={},0!==e.length){e.indexOf("?")>=0&&(e=e.split("?")[1]);for(var n=e.split("&"),r=0;r<n.length;r++){var i=n[r].split("=");t[i[0]]=i[1],t.user_query[i[0]]=i[1]}t.domain&&(t.vhost=t.domain)}}},t.pc=new RTCPeerConnection(null),t.stream=new MediaStream,t}function RtcPlayer(e){var t={play:async function(e,n,r){var i=t.__internal.prepareUrl(n);t.pc.addTransceiver("audio",{direction:"recvonly"}),t.pc.addTransceiver("video",{direction:"recvonly"});var o=await t.pc.createOffer();await t.pc.setLocalDescription(o);let a=new fpnn.FPClient({endpoint:"wss://"+e+"/service/websocket",autoReconnect:!1,connectionTimeout:1e4});a.connect(),a.on("connect",function(){var e={api:i.apiUrl,tid:i.tid,streamurl:i.streamUrl,clientip:"",sdp:o.sdp};let n={flag:1,method:"OnUserPlay",payload:msgpack.encode(e)};a.sendQuest(n,function(e){session=rtm.RTMConfig.MsgPack.decode(e.payload,{codec:rtm.RTMConfig.MsgPack.createCodec({int64:!0})}),t.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:session.sdp})),session.simulator=i.schema+"//"+i.urlObject.server+":"+i.port+"/rtc/v1/nack/",r(session)},1e4)})},close:function(){t.pc&&t.pc.close(),t.pc=null},ontrack:function(e){t.stream.addTrack(e.track)}};return t.__internal={defaultPath:"/rtc/v1/play/",prepareUrl:function(e){var n=t.__internal.parse(e),r=n.user_query.schema;r=r?r+":":window.location.protocol;var i=n.port||1985;"https:"===r&&(i=n.port||443);var o=n.user_query.play||t.__internal.defaultPath;for(var a in o.lastIndexOf("/")!==o.length-1&&(o+="/"),l=r+"//"+n.server+":"+i+o,n.user_query)"api"!==a&&"play"!==a&&(l+="&"+a+"="+n.user_query[a]);var l=l.replace(o+"&",o+"?");return{apiUrl:l,streamUrl:n.url,schema:r,urlObject:n,port:i,tid:Number(parseInt((new Date).getTime()*Math.random()*100)).toString(16).slice(0,7)}},parse:function(e){var n=document.createElement("a");n.href=e.replace("rtmp://","http://").replace("webrtc://","http://").replace("rtc://","http://");var r=n.hostname,i=n.pathname.substring(1,n.pathname.lastIndexOf("/")),o=n.pathname.slice(n.pathname.lastIndexOf("/")+1);if((i=i.replace("...vhost...","?vhost=")).indexOf("?")>=0){var a=i.slice(i.indexOf("?"));i=i.slice(0,i.indexOf("?")),a.indexOf("vhost=")>0&&(r=a.slice(a.indexOf("vhost=")+"vhost=".length)).indexOf("&")>0&&(r=r.slice(0,r.indexOf("&")))}if(n.hostname===r){/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/.test(n.hostname)&&(r="__defaultVhost__")}var l="rtmp";e.indexOf("://")>0&&(l=e.slice(0,e.indexOf("://")));var s=n.port;s||("http"===l?s=80:"https"===l?s=443:"rtmp"===l&&(s=1935));var c={url:e,schema:l,server:n.hostname,port:s,vhost:r,app:i,stream:o};return t.__internal.fill_query(n.search,c),c.port||"webrtc"!==l&&"rtc"!==l||("https"===c.user_query.schema?c.port=443:0===window.location.href.indexOf("https://")?c.port=443:c.port=1985),c},fill_query:function(e,t){if(t.user_query={},0!==e.length){e.indexOf("?")>=0&&(e=e.split("?")[1]);for(var n=e.split("&"),r=0;r<n.length;r++){var i=n[r].split("=");t[i[0]]=i[1],t.user_query[i[0]]=i[1]}t.domain&&(t.vhost=t.domain)}}},t.pc=new RTCPeerConnection(null),t.stream=new MediaStream,t.pc.ontrack=function(e){t.ontrack&&t.ontrack(e)},t}function initRTMClient(e){if(this._options=e,null==this.rtmClient){this.rtmClient=new rtm.RTMClient({ssl_endpoint:e.rtmEndpoint,autoReconnect:!0,connectionTimeout:e.connectionTimeout||1e4,pid:e.pid});let t=this;this.rtmClient.processor.on(rtm.RTMConfig.SERVER_PUSH.recvRoomCmd,function(e){try{let r=e.rid.toString(),i=e.from.toString(),o=JSON.parse(e.attrs);if(void 0!==o&&"rtc-signal"==o.name)rtcEventHandler.call(t,r,i,o);else if(void 0!==o&&"rtc-heartbeat"==o.name)if(void 0===t._roomPlayersMap[i]){let e=new RTCRoomMember;e.roomID=r,e.userID=i,e.player=new RtcPlayer,e.cameraEnabled=1===o.cameraEnabled,e.microphoneEnabled=1===o.microphoneEnabled;let n="webrtc://"+t._options.rtcEndpoint+"/"+RTCClient._pid+"/"+r+"/"+i;e.player.play(t._options.rtcEndpoint,n,function(n){t._roomPlayersMap[i]=e,t.emit("RoomMembersChanged",{enter:[e],leave:[],change:[],all:t._roomPlayersMap})})}else{t._roomPlayersMap[i].activeTime=parseInt((new Date).getTime()/1e3);var n=[];let e=1==o.cameraEnabled,r=1==o.microphoneEnabled;if(t._roomPlayersMap[i].cameraEnabled!==e){t._roomPlayersMap[i].cameraEnabled=e;let r=new RTCStatusChangedInfo;r.userID=i,r.changedEvent=e?RTC_EVENT.RTC_EV_CAMERA_OPEN:RTC_EVENT.RTC_EV_CAMERA_CLOSE,n.push(r)}if(t._roomPlayersMap[i].microphoneEnabled!==r){t._roomPlayersMap[i].microphoneEnabled=r;let e=new RTCStatusChangedInfo;e.userID=i,e.changedEvent=r?RTC_EVENT.RTC_EV_MICROPHONE_OPEN:RTC_EVENT.RTC_EV_MICROPHONE_CLOSE,n.push(e)}n.length>0&&t.emit("RoomMembersChanged",{enter:[],leave:[],change:n,all:t._roomPlayersMap})}}catch(e){}}),this.rtmClient.on("ErrorRecorder",function(e){t.emit("ErrorRecorder",e)}),this.rtmClient.on("ReloginCompleted",function(e,n,r,i){e&&null!==RTCClient._enterRoomID&&t.rtmClient.enterRoom(new rtm.RTMConfig.Int64(RTCClient._enterRoomID),t._options.connectionTimeout,function(e,n){if(null===e){t._publisher&&t._publisher.close(),t._publisher=new RtcPublisher({video:!0,audio:!0});var r="webrtc://"+t._options.rtcEndpoint+"/"+RTCClient._pid+"/"+RTCClient._enterRoomID+"/"+t.rtmClient._uid.toString();t._publisher.publish(t._options.rtcEndpoint,r,function(e){t.enableCamera(t.enableCamera),t.enableMicrophone(t.enableMicrophone),sendSignaling.call(t,RTCClient._enterRoomID,RTC_EVENT.RTC_EV_ENTER,t.enableCamera,t.enableMicrophone)})}}),t.emit("ReloginCompleted",e,n,r,i)}),this.rtmClient.on("SessionClosed",function(e){t.emit("SessionClosed",e)})}}function sendSignaling(e,t,n,r,i){if(null!==this.rtmClient){var o='{"name":"rtc-signal", "type":'+t;if(void 0!==n){o+=', "cameraEnabled":'+(n?1:0)}if(void 0!==r){o+=', "microphoneEnabled":'+(n?1:0)}o+="}",this.rtmClient.sendRoomCmd(e,"",o,0,this._options.connectionTimeout,function(e,t){void 0!==i&&i(e,t)})}}function sendHeartbeat(e,t){if(null!==this.rtmClient){var n='{"name":"rtc-heartbeat", "cameraEnabled":'+(this.cameraEnabled?1:0)+', "microphoneEnabled":'+(this.microphoneEnabled?1:0)+"}";this.rtmClient.sendRoomCmd(e,"",n,0,this._options.connectionTimeout,function(e,n){void 0!==t&&t(e,n)})}}function rtcEventHandler(e,t,n){if(e==RTCClient._enterRoomID)if(n.type===RTC_EVENT.RTC_EV_ENTER&&void 0===this._roomPlayersMap[t]){let r=new RTCRoomMember;r.roomID=e,r.userID=t,r.player=new RtcPlayer,r.cameraEnabled=1===n.cameraEnabled,r.microphoneEnabled=1===n.microphoneEnabled;let i="webrtc://"+this._options.rtcEndpoint+"/"+RTCClient._pid+"/"+e+"/"+t,o=this;r.player.play(this._options.rtcEndpoint,i,function(e){o._roomPlayersMap[t]=r,o.emit("RoomMembersChanged",{enter:[r],leave:[],change:[],all:o._roomPlayersMap})})}else if(n.type===RTC_EVENT.RTC_EV_LEAVE&&void 0!==this._roomPlayersMap[t]){let e=this._roomPlayersMap[t];e.player.close(),e.cameraEnabled=!1,e.microphoneEnabled=!1,delete this._roomPlayersMap[t],this.emit("RoomMembersChanged",{enter:[],leave:[e],change:[],all:this._roomPlayersMap})}else if(n.type>=RTC_EVENT.RTC_EV_CAMERA_CLOSE&&n.type<=RTC_EVENT.RTC_EV_MICROPHONE_OPEN&&void 0!==this._roomPlayersMap[t]){let e=new RTCStatusChangedInfo;e.userID=t,e.changedEvent=n.type,void 0!==this._roomPlayersMap[t]&&(e.changedEvent==RTC_EVENT.RTC_EV_CAMERA_CLOSE&&(this._roomPlayersMap[t].cameraEnabled=!1),e.changedEvent==RTC_EVENT.RTC_EV_CAMERA_OPEN&&(this._roomPlayersMap[t].cameraEnabled=!0),e.changedEvent==RTC_EVENT.RTC_EV_MICROPHONE_CLOSE&&(this._roomPlayersMap[t].microphoneEnabled=!1),e.changedEvent==RTC_EVENT.RTC_EV_MICROPHONE_OPEN&&(this._roomPlayersMap[t].microphoneEnabled=!0)),this.emit("RoomMembersChanged",{enter:[],leave:[],change:[e],all:this._roomPlayersMap})}}function roomMemberLeave(e){if(void 0!==this._roomPlayersMap[e]){let t=this._roomPlayersMap[e];t.cameraEnabled=!1,t.microphoneEnabled=!1,t.player.close(),delete this._roomPlayersMap[e],this.emit("RoomMembersChanged",{enter:[],leave:[t],change:[],all:this._roomPlayersMap})}}class RTCRoomMember{constructor(){this.roomID="",this.userID="",this.player=null,this.cameraEnabled=!1,this.microphoneEnabled=!1,this.activeTime=parseInt((new Date).getTime()/1e3)}getStream(){return null!==this.player?this.player.stream:null}enableMicrophone(e){if(null!==this.player){let n=this.player.stream.getAudioTracks();for(var t=0;t<n.length;t++)n[t].enabled=e}}enableCamera(e){if(null!==this.player){let n=this.player.stream.getVideoTracks();for(var t=0;t<n.length;t++)n[t].enabled=e}}}class RTCStatusChangedInfo{constructor(){this.changedEvent=-1,this.userID=""}}class RTCClient{constructor(e){fpnn.FPEvent.assign(this),RTCClient._pid=null,RTCClient._uid=null,RTCClient._login=!1,RTCClient._enterRoomID=null,RTCClient._heartbeatTimer=null,RTCClient._checkActiveTime=parseInt((new Date).getTime()/1e3),this.rtmClient=null,this._publisher=null,this._roomPlayersMap={},this.cameraEnabled=!0,this.microphoneEnabled=!0,RTCClient._pid=e.pid,initRTMClient.call(this,e)}getSDKVersion(){return RTC_SDK_VERSION}login(e,t,n,r){RTCClient._login?n(!1,RTC_ERROR_CODE.RTC_EC_ALREADY_LOGIN):this.rtmClient.login(e,t,function(t,r){r==fpnn.FPConfig.ERROR_CODE.FPNN_EC_OK&&t&&(RTCClient._login=!0,RTCClient._uid=e),n(t,r)},r)}logout(){if(null!==RTCClient._enterRoomID){let e=this;this.leaveRoom(this._options.connectionTimeout,function(t,n){e.rtmClient.close(),RTCClient._login=!1,RTCClient._uid=null})}else this.rtmClient.close(),RTCClient._login=!1,RTCClient._uid=null}leaveRoom(e,t){if(null!==RTCClient._enterRoomID){let n=this;sendSignaling.call(this,new rtm.RTMConfig.Int64(RTCClient._enterRoomID),RTC_EVENT.RTC_EV_LEAVE,void 0,void 0,function(r,i){null===r?n.rtmClient.leaveRoom(new rtm.RTMConfig.Int64(RTCClient._enterRoomID),e,function(e,r){n.destoryRoom(),void 0!==t&&t(e,r)}):t(r,i)})}null!==RTCClient._heartbeatTimer&&clearInterval(RTCClient._heartbeatTimer)}destoryRoom(){RTCClient._enterRoomID=null;let e=this._publisher.stream.getTracks();for(var t=0;t<e.length;t++)e[t].stop();for(var n in this._publisher.close(),this._publisher=null,this._roomPlayersMap)this._roomPlayersMap[n].player.close();this._roomPlayersMap={},null!==RTCClient._heartbeatTimer&&clearInterval(RTCClient._heartbeatTimer)}enableMicrophone(e){if(null!==this._publisher&&null!==RTCClient._enterRoomID){let r=this._publisher.stream.getAudioTracks();for(var t=0;t<r.length;t++)r[t].enabled=e;var n=RTC_EVENT.RTC_EV_MICROPHONE_CLOSE;e&&(n=RTC_EVENT.RTC_EV_MICROPHONE_OPEN),this.microphoneEnabled=e,sendSignaling.call(this,new rtm.RTMConfig.Int64(RTCClient._enterRoomID),n)}}enableCamera(e){if(null!==this._publisher&&null!==RTCClient._enterRoomID){let r=this._publisher.stream.getVideoTracks();for(var t=0;t<r.length;t++)r[t].enabled=e;var n=RTC_EVENT.RTC_EV_CAMERA_CLOSE;e&&(n=RTC_EVENT.RTC_EV_CAMERA_OPEN),this.cameraEnabled=e,sendSignaling.call(this,new rtm.RTMConfig.Int64(RTCClient._enterRoomID),n)}}isLogin(){return RTCClient._login}getLoginUserID(){return RTCClient._uid}enterAudioRoom(e,t,n,r){this.enterRoom(e,n,!1,t,r)}enterVideoRoom(e,t,n,r,i){this.enterRoom(e,r,t,n,i)}enterRoom(e,t,n,r,i){if(null!==RTCClient._enterRoomID)return void i(new fpnn.FPError(rtm.RTMConfig.ERROR_CODE.RTM_EC_ENTER_TOO_MANY_ROOMS,Error("already joined a room")),null,null);let o=this;this.rtmClient.enterRoom(e,t,function(a,l){if(null===a){o._publisher&&o._publisher.close(),o._publisher=new RtcPublisher({video:!0,audio:!0});var s="webrtc://"+o._options.rtcEndpoint+"/"+RTCClient._pid+"/"+e.toString()+"/"+o.rtmClient._uid.toString();o._publisher.publish(o._options.rtcEndpoint,s,function(a){RTCClient._enterRoomID=e.toString(),o.enableCamera(n),o.enableMicrophone(r),o.rtmClient.getRoomMembers(e,t,function(t,a){if(null===t){for(var l in a.uids){let e=new RTCRoomMember;e.roomID=RTCClient._enterRoomID,e.userID=a.uids[l].toString(),e.player=new RtcPlayer,e.cameraEnabled=!0,e.microphoneEnabled=!0;let t="webrtc://"+o._options.rtcEndpoint+"/"+RTCClient._pid+"/"+e.roomID+"/"+e.userID;e.player.play(o._options.rtcEndpoint,t,function(e){}),o._roomPlayersMap[e.userID]=e}i(fpnn.FPConfig.ERROR_CODE.FPNN_EC_OK,o._publisher.stream,o._roomPlayersMap),sendSignaling.call(o,e,RTC_EVENT.RTC_EV_ENTER,n,r),null!==RTCClient._heartbeatTimer&&(clearInterval(RTCClient._heartbeatTimer),RTCClient._checkActiveTime=parseInt((new Date).getTime()/1e3)),RTCClient._heartbeatTimer=setInterval(function(){null!==RTCClient._enterRoomID&&sendHeartbeat.call(o,new rtm.RTMConfig.Int64(e))},2e3)}else i(t,null,null)})})}else i(a,null,null)})}getRTCRoomMembers(){return null!==RTCClient._enterRoomID?this._roomPlayersMap:{}}}